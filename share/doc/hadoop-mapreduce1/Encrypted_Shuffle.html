<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<META http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta content="Apache Forrest" name="Generator">
<meta name="Forrest-version" content="0.8">
<meta name="Forrest-skin-name" content="pelt">
<title>
      Hadoop Encrypted Shuffle
    </title>
<link type="text/css" href="skin/basic.css" rel="stylesheet">
<link media="screen" type="text/css" href="skin/screen.css" rel="stylesheet">
<link media="print" type="text/css" href="skin/print.css" rel="stylesheet">
<link type="text/css" href="skin/profile.css" rel="stylesheet">
<script src="skin/getBlank.js" language="javascript" type="text/javascript"></script><script src="skin/getMenu.js" language="javascript" type="text/javascript"></script><script src="skin/fontsize.js" language="javascript" type="text/javascript"></script>
<link rel="shortcut icon" href="images/favicon.ico">
</head>
<body onload="init()">
<script type="text/javascript">ndeSetTextSize();</script>
<div id="top">
<!--+
    |breadtrail
    +-->
<div class="breadtrail">
<a href="http://www.apache.org/">Apache</a> &gt; <a href="http://hadoop.apache.org/">Hadoop</a> &gt; <a href="http://hadoop.apache.org/core/">Core</a><script src="skin/breadcrumbs.js" language="JavaScript" type="text/javascript"></script>
</div>
<!--+
    |header
    +-->
<div class="header">
<!--+
    |start group logo
    +-->
<div class="grouplogo">
<a href="http://hadoop.apache.org/"><img class="logoImage" alt="Hadoop" src="images/hadoop-logo.jpg" title="Apache Hadoop"></a>
</div>
<!--+
    |end group logo
    +-->
<!--+
    |start Project Logo
    +-->
<div class="projectlogo">
<a href="http://hadoop.apache.org/core/"><img class="logoImage" alt="Hadoop" src="images/hadoop-logo-2.gif" title="Scalable Computing Platform"></a>
</div>
<!--+
    |end Project Logo
    +-->
<!--+
    |start Search
    +-->
<div class="searchbox">
<form action="http://www.google.com/search" method="get" class="roundtopsmall">
<input value="archive.cloudera.com" name="sitesearch" type="hidden"><input onFocus="getBlank (this, 'Search the site with google');" size="25" name="q" id="query" type="text" value="Search the site with google">&nbsp; 
                    <input name="Search" value="Search" type="submit">
</form>
</div>
<!--+
    |end search
    +-->
<!--+
    |start Tabs
    +-->
<ul id="tabs">
<li>
<a class="unselected" href="http://hadoop.apache.org/core/">Project</a>
</li>
<li>
<a class="unselected" href="http://wiki.apache.org/hadoop">Wiki</a>
</li>
<li class="current">
<a class="selected" href="index.html">Hadoop 0.20 Documentation</a>
</li>
</ul>
<!--+
    |end Tabs
    +-->
</div>
</div>
<div id="main">
<div id="publishedStrip">
<!--+
    |start Subtabs
    +-->
<div id="level2tabs"></div>
<!--+
    |end Endtabs
    +-->
<script type="text/javascript"><!--
document.write("Last Published: " + document.lastModified);
//  --></script>
</div>
<!--+
    |breadtrail
    +-->
<div class="breadtrail">

             &nbsp;
           </div>
<!--+
    |start Menu, mainarea
    +-->
<!--+
    |start Menu
    +-->
<div id="menu">
<div onclick="SwitchMenu('menu_1.1', 'skin/')" id="menu_1.1Title" class="menutitle">Getting Started</div>
<div id="menu_1.1" class="menuitemgroup">
<div class="menuitem">
<a href="index.html">Overview</a>
</div>
<div class="menuitem">
<a href="single_node_setup.html">Single Node Setup</a>
</div>
<div class="menuitem">
<a href="cluster_setup.html">Cluster Setup</a>
</div>
</div>
<div onclick="SwitchMenu('menu_1.2', 'skin/')" id="menu_1.2Title" class="menutitle">Guides</div>
<div id="menu_1.2" class="menuitemgroup">
<div class="menuitem">
<a href="HttpAuthentication.html">Authentication for Hadoop HTTP web-consoles</a>
</div>
</div>
<div onclick="SwitchMenu('menu_1.3', 'skin/')" id="menu_1.3Title" class="menutitle">MapReduce</div>
<div id="menu_1.3" class="menuitemgroup">
<div class="menuitem">
<a href="mapred_tutorial.html">MapReduce Tutorial</a>
</div>
<div class="menuitem">
<a href="streaming.html">Hadoop Streaming</a>
</div>
<div class="menuitem">
<a href="commands_manual.html">Hadoop Commands</a>
</div>
<div class="menuitem">
<a href="distcp.html">DistCp</a>
</div>
<div class="menuitem">
<a href="vaidya.html">Vaidya</a>
</div>
<div class="menuitem">
<a href="hadoop_archives.html">Hadoop Archives</a>
</div>
<div class="menuitem">
<a href="gridmix.html">Gridmix</a>
</div>
<div class="menuitem">
<a href="capacity_scheduler.html">Capacity Scheduler</a>
</div>
<div class="menuitem">
<a href="fair_scheduler.html">Fair Scheduler</a>
</div>
<div class="menuitem">
<a href="hod_scheduler.html">Hod Scheduler</a>
</div>
</div>
<div onclick="SwitchMenu('menu_1.4', 'skin/')" id="menu_1.4Title" class="menutitle">HDFS</div>
<div id="menu_1.4" class="menuitemgroup">
<div class="menuitem">
<a href="hdfs_user_guide.html">HDFS Users </a>
</div>
<div class="menuitem">
<a href="hdfs_design.html">HDFS Architecture</a>
</div>
<div class="menuitem">
<a href="hdfs_permissions_guide.html">Permissions</a>
</div>
<div class="menuitem">
<a href="hdfs_quota_admin_guide.html">Quotas</a>
</div>
<div class="menuitem">
<a href="hdfs_imageviewer.html">Offline Image Viewer Guide</a>
</div>
<div class="menuitem">
<a href="SLG_user_guide.html">Synthetic Load Generator</a>
</div>
<div class="menuitem">
<a href="libhdfs.html">C API libhdfs</a>
</div>
</div>
<div onclick="SwitchMenu('menu_1.5', 'skin/')" id="menu_1.5Title" class="menutitle">Common</div>
<div id="menu_1.5" class="menuitemgroup">
<div class="menuitem">
<a href="file_system_shell.html">File System Shell</a>
</div>
<div class="menuitem">
<a href="service_level_auth.html">Service Level Authorization</a>
</div>
<div class="menuitem">
<a href="native_libraries.html">Native Libraries</a>
</div>
</div>
<div onclick="SwitchMenu('menu_selected_1.6', 'skin/')" id="menu_selected_1.6Title" class="menutitle" style="background-image: url('skin/images/chapter_open.gif');">Miscellaneous</div>
<div id="menu_selected_1.6" class="selectedmenuitemgroup" style="display: block;">
<div class="menuitem">
<a href="Secure_Impersonation.html">Secure Impersonation</a>
</div>
<div class="menupage">
<div class="menupagetitle">Encrypted Shuffle</div>
</div>
<div class="menuitem">
<a href="Pluggable_Sort.html">Pluggable Sort</a>
</div>
<div class="menuitem">
<a href="api/index.html">API Docs</a>
</div>
<div class="menuitem">
<a href="jdiff/changes.html">API Changes</a>
</div>
<div class="menuitem">
<a href="http://wiki.apache.org/hadoop/">Wiki</a>
</div>
<div class="menuitem">
<a href="http://wiki.apache.org/hadoop/FAQ">FAQ</a>
</div>
<div class="menuitem">
<a href="releasenotes.html">Release Notes</a>
</div>
<div class="menuitem">
<a href="changes.html">Change Log</a>
</div>
</div>
<div id="credit"></div>
<div id="roundbottom">
<img style="display: none" class="corner" height="15" width="15" alt="" src="skin/images/rc-b-l-15-1body-2menu-3menu.png"></div>
<!--+
  |alternative credits
  +-->
<div id="credit2"></div>
</div>
<!--+
    |end Menu
    +-->
<!--+
    |start content
    +-->
<div id="content">
<div title="Portable Document Format" class="pdflink">
<a class="dida" href="Encrypted_Shuffle.pdf"><img alt="PDF -icon" src="skin/images/pdfdoc.gif" class="skin"><br>
        PDF</a>
</div>
<h1>
      Hadoop Encrypted Shuffle
    </h1>
<div id="minitoc-area">
<ul class="minitoc">
<li>
<a href="#Introduction">Introduction</a>
</li>
<li>
<a href="#Configuration">Configuration</a>
</li>
<li>
<a href="#Keystore+and+Truststore+Settings">Keystore and Truststore Settings</a>
</li>
<li>
<a href="#Activating+Encrypted+Shuffle">Activating Encrypted Shuffle</a>
</li>
<li>
<a href="#Client+Certificates">Client Certificates</a>
</li>
<li>
<a href="#Reloading+Truststores">Reloading Truststores</a>
</li>
<li>
<a href="#Debugging">Debugging</a>
</li>
</ul>
</div>
    
<a name="N1000D"></a><a name="Introduction"></a>
<h2 class="h3">Introduction</h2>
<div class="section">
<p>
        The Encrypted Shuffle capability allows encryption of the MapReduce
        shuffle
        using HTTPS and with optional client authentication (also known as
        bi-directional HTTPS, or HTTPS with client certificates). It comprises:
      </p>
<ul>
          
<li>A Hadoop configuration setting for toggling the shuffle between
            HTTP and
            HTTPS.
          </li>
          
<li>A Hadoop configuration settings for specifying the keystore and
            truststore
            properties (location, type, passwords) used by the shuffle service
            and the
            reducers tasks fetching shuffle data.
          </li>
          
<li>A way to re-load truststores across the cluster (when a node is
            added or
            removed).
          </li>
        
</ul>
</div>

    
<a name="N10023"></a><a name="Configuration"></a>
<h2 class="h3">Configuration</h2>
<div class="section">
<p>
        
<strong>core-site.xml</strong>
        Properties
      </p>
<p>To enable encrypted shuffle, set the following properties in
        <strong>core-site.xml</strong>
        of all nodes in the cluster:
      </p>
<ul>
        
<li>
<strong>hadoop.ssl.require.client.cert</strong>. Default:<strong>false</strong>.
          Whether client certificates are required
        </li>
        
<li>
<strong>hadoop.ssl.hostname.verifier</strong>. Default:<strong>DEFAULT</strong>.
          The hostname verifier to provide for HttpsURLConnections. Valid
          values are:<strong>DEFAULT</strong>,<strong>STRICT</strong>,<strong>STRICT_I6</strong>,
          <strong>DEFAULT_AND_LOCALHOST</strong>
          and
          <strong>ALLOW_ALL</strong>
        
</li>
        
<li>
<strong>hadoop.ssl.keystores.factory.class</strong>. Default:
          <strong>org.apache.hadoop.security.ssl.FileBasedKeyStoresFactory</strong>
          .
          The KeyStoresFactory implementation to use
        </li>
        
<li>
<strong>hadoop.ssl.server.conf</strong>. Default:<strong>ss-server.xml</strong>.
          Resource file from which ssl server keystore information will be
          extracted. This file is looked up in the classpath, typically it
          should be in Hadoop conf/ directory
        </li>
        
<li>
<strong>hadoop.ssl.client.conf</strong>. Default:<strong>ss-client.xml</strong>.
          Resource file from which ssl server keystore information will be
          extracted. This file is looked up in the classpath, typically it
          should be in Hadoop conf/ directory
        </li>
      
</ul>
<p>
        
<strong>IMPORTANT:</strong>
        Currently requiring client certificates should be set
        to false. Refer the Client Certificates section for details.
      </p>
<p>
        
<strong>IMPORTANT:</strong>
        All these properties should be marked as final in
        the cluster configuration files.
      </p>
<p>
        
<strong>Example:</strong>
      
</p>
<pre class="code">
          ...
          &lt;property&gt;
            &lt;name&gt;hadoop.ssl.require.client.cert&lt;/name&gt;
            &lt;value&gt;false&lt;/value&gt;
            &lt;final&gt;true&lt;/final&gt;
          &lt;/property&gt;

          &lt;property&gt;
            &lt;name&gt;hadoop.ssl.hostname.verifier&lt;/name&gt;
            &lt;value&gt;DEFAULT&lt;/value&gt;
            &lt;final&gt;true&lt;/final&gt;
          &lt;/property&gt;

          &lt;property&gt;
            &lt;name&gt;hadoop.ssl.keystores.factory.class&lt;/name&gt;
            &lt;value&gt;org.apache.hadoop.security.ssl.FileBasedKeyStoresFactory
            &lt;/value&gt;
            &lt;final&gt;true&lt;/final&gt;
          &lt;/property&gt;

          &lt;property&gt;
            &lt;name&gt;hadoop.ssl.server.conf&lt;/name&gt;
            &lt;value&gt;ssl-server.xml&lt;/value&gt;
            &lt;final&gt;true&lt;/final&gt;
          &lt;/property&gt;

          &lt;property&gt;
            &lt;name&gt;hadoop.ssl.client.conf&lt;/name&gt;
            &lt;value&gt;ssl-client.xml&lt;/value&gt;
            &lt;final&gt;true&lt;/final&gt;
          &lt;/property&gt;
          ...
        </pre>
<p>
        
<strong>mapred-site.xml</strong>
        Properties
      </p>
<p>To enable encrypted shuffle, set the following property in
        <strong>mapred-site.xml</strong>
        of all nodes in the cluster:
      </p>
<ul>
        
<li>
<strong>mapreduce.shuffle.ssl.enabled</strong>. Default:<strong>false</strong>.
          Whether encrypted shuffle is enabled
        </li>
      
</ul>
<p>
        
<strong>IMPORTANT:</strong>
        All these properties should be marked as final in
        the cluster configuration files.
      </p>
<p>
        
<strong>Example:</strong>
      
</p>
<pre class="code">
          ...
          &lt;property&gt;
            &lt;name&gt;mapreduce.shuffle.ssl.enabled&lt;/name&gt;
            &lt;value&gt;true&lt;/value&gt;
          &lt;/property&gt;
          ...
        </pre>
<p>The Linux container executor should be set to prevent job tasks from
      reading the server keystore information and gaining access to the shuffle
      server certificates.
      </p>
<p>Refer to Hadoop Kerberos configuration for details on how to do this.
      </p>
</div>

    
<a name="N100B3"></a><a name="Keystore+and+Truststore+Settings"></a>
<h2 class="h3">Keystore and Truststore Settings</h2>
<div class="section">
<p>Currently <strong>FileBasedKeyStoresFactory</strong> is the only
        <strong>KeyStoresFactory</strong> implementation. The
        <strong>FileBasedKeyStoresFactory</strong> implementation uses the following
        properties, in the <strong>ssl-server.xml</strong> and <strong>ssl-client.xml</strong>
        files, to configure the keystores and truststores.
      </p>
<p>
<strong>ssl-server.xml</strong> (Shuffle server) Configuration:
      </p>
<p>The mapred user should own the <strong>ssl-server.xml</strong> file and have
      exclusive read access to it.
      </p>
<ul>
        
<li>
<strong>ssl.server.keystore.type</strong>. Default <strong>jks</strong>.
          Keystore file type</li>
        
<li>
<strong>ssl.server.keystore.location</strong>. Default <strong>NONE</strong>.
          Keystore file location. The mapred user should own this file
          and have exclusive read access to it</li>
        
<li>
<strong>ssl.server.keystore.password</strong>. Default <strong>NONE</strong>.
          Keystore file password</li>
        
<li>
<strong>ssl.server.truststore.type</strong>. Default <strong>jks</strong>.
          Truststore file type</li>
        
<li>
<strong>ssl.server.truststore.location</strong>. Default <strong>NONE</strong>.
          Truststore file location. The mapred user should own this file
          and have exclusive read access to it</li>
        
<li>
<strong>ssl.server.truststore.password</strong>. Default <strong>NONE</strong>.
          Truststore file password</li>
        
<li>
<strong>ssl.server.truststore.reload.interval</strong>. Default <strong>10</strong>.
          Truststore reload interval, in milliseconds</li>
      
</ul>
<p>
        
<strong>Example:</strong>
      
</p>
<pre class="code">
          &lt;configuration&gt;

            &lt;!-- Server Certificate Store --&gt;
            &lt;property&gt;
              &lt;name&gt;ssl.server.keystore.type&lt;/name&gt;
              &lt;value&gt;jks&lt;/value&gt;
            &lt;/property&gt;
            &lt;property&gt;
              &lt;name&gt;ssl.server.keystore.location&lt;/name&gt;
              &lt;value&gt;${user.home}/keystores/server-keystore.jks&lt;/value&gt;
            &lt;/property&gt;
            &lt;property&gt;
              &lt;name&gt;ssl.server.keystore.password&lt;/name&gt;
              &lt;value&gt;serverfoo&lt;/value&gt;
            &lt;/property&gt;

            &lt;!-- Server Trust Store --&gt;
            &lt;property&gt;
              &lt;name&gt;ssl.server.truststore.type&lt;/name&gt;
              &lt;value&gt;jks&lt;/value&gt;
            &lt;/property&gt;
            &lt;property&gt;
              &lt;name&gt;ssl.server.truststore.location&lt;/name&gt;
              &lt;value&gt;${user.home}/keystores/truststore.jks&lt;/value&gt;
            &lt;/property&gt;
            &lt;property&gt;
              &lt;name&gt;ssl.server.truststore.password&lt;/name&gt;
              &lt;value&gt;clientserverbar&lt;/value&gt;
            &lt;/property&gt;
            &lt;property&gt;
              &lt;name&gt;ssl.server.truststore.reload.interval&lt;/name&gt;
              &lt;value&gt;10000&lt;/value&gt;
            &lt;/property&gt;
          &lt;/configuration&gt;
        </pre>
<p>
<strong>ssl-client.xml</strong> (Reducer/Fetcher) Configuration:
      </p>
<p>The mapred user should own the <strong>ssl-server.xml</strong> file and it should
        have default permissions.
      </p>
<ul>
          
<li>
<strong>ssl.client.keystore.type</strong>. Default <strong>jks</strong>.
            Keystore file type</li>
          
<li>
<strong>ssl.client.keystore.location</strong>. Default <strong>NONE</strong>.
            Keystore file location. The mapred user should own this file
            and have exclusive read access to it</li>
          
<li>
<strong>ssl.client.keystore.password</strong>. Default <strong>NONE</strong>.
            Keystore file password</li>
          
<li>
<strong>ssl.client.truststore.type</strong>. Default <strong>jks</strong>.
            Truststore file type</li>
          
<li>
<strong>ssl.client.truststore.location</strong>. Default <strong>NONE</strong>.
            Truststore file location. The mapred user should own this file
            and have exclusive read access to it</li>
          
<li>
<strong>ssl.client.truststore.password</strong>. Default <strong>NONE</strong>.
            Truststore file password</li>
          
<li>
<strong>ssl.client.truststore.reload.interval</strong>. Default <strong>10</strong>.
            Truststore reload interval, in milliseconds</li>
        
</ul>
<p>
        
<strong>Example:</strong>
      
</p>
<pre class="code">
          &lt;configuration&gt;

            &lt;!-- Clietn Certificate Store --&gt;
            &lt;property&gt;
              &lt;name&gt;ssl.client.keystore.type&lt;/name&gt;
              &lt;value&gt;jks&lt;/value&gt;
            &lt;/property&gt;
            &lt;property&gt;
              &lt;name&gt;ssl.client.keystore.location&lt;/name&gt;
              &lt;value&gt;${user.home}/keystores/client-keystore.jks&lt;/value&gt;
            &lt;/property&gt;
            &lt;property&gt;
              &lt;name&gt;ssl.client.keystore.password&lt;/name&gt;
              &lt;value&gt;clientfoo&lt;/value&gt;
            &lt;/property&gt;

            &lt;!-- Client Trust Store --&gt;
            &lt;property&gt;
              &lt;name&gt;ssl.client.truststore.type&lt;/name&gt;
              &lt;value&gt;jks&lt;/value&gt;
            &lt;/property&gt;
            &lt;property&gt;
              &lt;name&gt;ssl.client.truststore.location&lt;/name&gt;
              &lt;value&gt;${user.home}/keystores/truststore.jks&lt;/value&gt;
            &lt;/property&gt;
            &lt;property&gt;
              &lt;name&gt;ssl.client.truststore.password&lt;/name&gt;
              &lt;value&gt;clientbar&lt;/value&gt;
            &lt;/property&gt;
            &lt;property&gt;
              &lt;name&gt;ssl.client.truststore.reload.interval&lt;/name&gt;
              &lt;value&gt;10000&lt;/value&gt;
            &lt;/property&gt;
          &lt;/configuration&gt;
        </pre>
</div>

    
<a name="N1016C"></a><a name="Activating+Encrypted+Shuffle"></a>
<h2 class="h3">Activating Encrypted Shuffle</h2>
<div class="section">
<p>When you have made the above configuration changes, activate Encrypted
      Shuffle by re-starting all TaskTrackers.
      </p>
<p>
<strong>IMPORTANT:</strong> Using encrypted shuffle will incur in a significant
          performance impact. Users should profile this and potentially reserve
          1 or more cores for encrypted shuffle.
      </p>
</div>

    
<a name="N1017B"></a><a name="Client+Certificates"></a>
<h2 class="h3">Client Certificates</h2>
<div class="section">
<p>
        Using Client Certificates does not fully ensure that the client is a
        reducer task for the job. Currently, Client Certificates (their private key)
        keystore files must be readable by all users submitting jobs to the cluster.
        This means that a rogue job could read such those keystore files and use
        the client certificates in them to establish a secure connection with a
        Shuffle server. However, unless the rogue job has a proper JobToken, it won't
        be able to retrieve shuffle data from the Shuffle server. A job, using its
        own JobToken, can only retrieve shuffle data that belongs to itself.
      </p>
</div>

    
<a name="N10185"></a><a name="Reloading+Truststores"></a>
<h2 class="h3">Reloading Truststores</h2>
<div class="section">
<p>
        By default the truststores will reload their configuration every 10 seconds.
        If a new truststore file is copied over the old one, it will be re-read,
        and its certificates will replace the old ones. This mechanism is useful for
        adding or removing nodes from the cluster, or for adding or removing trusted
        clients. In these cases, the client or TaskTracker certificate is added to
        (or removed from) all the truststore files in the system, and the new
        configuration will be picked up without you having to restart the TaskTracker
      </p>
</div>

    
<a name="N1018F"></a><a name="Debugging"></a>
<h2 class="h3">Debugging</h2>
<div class="section">
<p>
<strong>NOTE:</strong> Enable debugging only for troubleshooting, and then only for jobs
      running on small amounts of data. It is very verbose and slows down jobs by
      several orders of magnitude. (You might need to increase mapred.task.timeout
      to prevent jobs from failing because tasks run so slowly.)
      </p>
<p>To enable SSL debugging in the reducers, set <strong>-Djavax.net.debug=all</strong>
      in the <strong>mapreduce.reduce.child.java.opts</strong> property; for example:
      </p>
<pre class="code">
      &lt;property&gt;
        &lt;name&gt;mapred.reduce.child.java.opts&lt;/name&gt;
        &lt;value&gt;-Xmx-200m -Djavax.net.debug=all&lt;/value&gt;
      &lt;/property&gt;
    </pre>
<p>You can do this on a per-job basis, or by means of a cluster-wide setting in
      the <strong>mapred-site.xml</strong> file.
      </p>
<p>To set this property in TaskTracker, set it in the <strong>hadoop-env.sh</strong>
      file:
      </p>
<pre class="code">
      HADOOP_OPTS="-Djavax.net.debug=all $HADOOP_OPTS"
      </pre>
</div>

  
</div>
<!--+
    |end content
    +-->
<div class="clearboth">&nbsp;</div>
</div>
<div id="footer">
<!--+
    |start bottomstrip
    +-->
<div class="lastmodified">
<script type="text/javascript"><!--
document.write("Last Published: " + document.lastModified);
//  --></script>
</div>
<div class="copyright">
        Copyright &copy;
         2008 <a href="http://www.apache.org/licenses/">The Apache Software Foundation.</a>
</div>
<!--+
    |end bottomstrip
    +-->
</div>
</body>
</html>
